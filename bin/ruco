#!/usr/bin/env ruby
require 'curses'

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)
require 'ruco'

def write(line,row,text)
  Curses.setpos(line,row)
  Curses.addstr(text);
end

def init_screen
  Curses.noecho # do not show typed chars
  Curses.init_screen
  Curses.stdscr.keypad(true) # enable arrow keys
  Curses.raw # give us all other keys

  begin
    yield
  ensure
    Curses.close_screen
  end
end

editor = Ruco::Editor.new(ARGV[0], :lines => Curses.stdscr.maxy, :columns => Curses.stdscr.maxx)

init_screen do
  loop do
    lines = editor.view.split("\n")
    Curses.stdscr.maxy.times do |i|
      line = lines[i] || ''
      clearer = Curses.stdscr.maxx - line.size
      clearer = " " * clearer
      write(i, 0, line + clearer)
    end

    Curses.setpos(editor.cursor_line, editor.cursor_column)

    case Curses.getch
    when Curses::Key::UP then editor.move(-1,0)
    when Curses::Key::DOWN then editor.move(1,0)
    when Curses::Key::RIGHT then editor.move(0,1)
    when Curses::Key::LEFT then editor.move(0,-1)
    when ?\C-w, ?\C-q then break # quit
    end
  end
end